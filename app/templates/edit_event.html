{% extends "_base.html" %}

{% block title %}Edit Event - Timeline App{% endblock %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.1.0/dist/maplibre-gl.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.1.0/dist/maplibre-gl.min.js"></script>
<style>
    #location-map {
        width: 100%;
        height: 300px;
        border-radius: 4px;
        display: none;
    }

    .map-overlay {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: white;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Edit Event</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.edit_event', event_id=event.id) }}">
                        <!-- Event Type -->
                        <div class="mb-3">
                            <label for="event_type" class="form-label">Event Type</label>
                            <select class="form-select" id="event_type" name="event_type" required>
                                <option value="meal" {% if event.event_type == 'meal' %}selected{% endif %}>Meal</option>
                                <option value="travel" {% if event.event_type == 'travel' %}selected{% endif %}>Travel</option>
                                <option value="hygiene" {% if event.event_type == 'hygiene' %}selected{% endif %}>Hygiene</option>
                                <option value="work" {% if event.event_type == 'work' %}selected{% endif %}>Work</option>
                                <option value="social" {% if event.event_type == 'social' %}selected{% endif %}>Social</option>
                                <option value="exercise" {% if event.event_type == 'exercise' %}selected{% endif %}>Exercise</option>
                                <option value="other" {% if event.event_type == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>

                        <!-- Event Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ event.title }}" required>
                        </div>

                        <!-- Event Date -->
                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ event_date }}" required>
                        </div>

                        <!-- Event Times -->
                        <div class="row mb-3">
                            <div class="col">
                                <label for="start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="start_time" name="start_time" value="{{ event_start_time }}" required>
                            </div>
                            <div class="col">
                                <label for="end_time" class="form-label">End Time <span class="text-muted">(Optional)</span></label>
                                <input type="time" class="form-control" id="end_time" name="end_time" value="{{ event_end_time or '' }}">
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="mb-3">
                            <label for="location_id" class="form-label">Location <span class="text-muted">(Optional)</span></label>
                            <div class="input-group mb-3">
                                <select class="form-select" id="location_id" name="location_id">
                                    <option value="">-- No Location --</option>
                                    {% for location in locations %}
                                    <option value="{{ location.id }}" {% if event.location_id == location.id %}selected{% endif %}>
                                        {{ location.place_name }}
                                    </option>
                                    {% endfor %}
                                    <option value="new">+ Add New Location</option>
                                </select>
                                <a href="{{ url_for('main.locations') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-gear"></i> Manage
                                </a>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes <span class="text-muted">(Optional)</span></label>
                            <textarea class="form-control" id="notes" name="notes" rows="3">{{ event.notes or '' }}</textarea>
                        </div>

                        <!-- Submit and Cancel buttons -->
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('main.timeline', date=event_date) }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const locationSelect = document.getElementById('location_id');
        const newLocationForm = document.getElementById('new-location-form');
        const locationMap = document.getElementById('location-map');
        let map, marker;

        // Handle location selection change
        locationSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                newLocationForm.style.display = 'block';
                locationMap.style.display = 'block';
                initializeMap();
            } else {
                newLocationForm.style.display = 'none';
                locationMap.style.display = 'none';
            }
        });

        // Initialize the map
        function initializeMap() {
            if (!map) {
                map = new maplibregl.Map({
                    container: 'location-map',
                    style: "https://api.protomaps.com/styles/v5/light/en.json?key={{ config.get('PROTOMAPS_API_KEY') }}",
                    center: [0, 0],
                    zoom: 2
                });

                // Add navigation controls
                map.addControl(new maplibregl.NavigationControl());

                // Create a draggable marker
                marker = new maplibregl.Marker({
                    draggable: true
                }).setLngLat([0, 0]).addTo(map);

                // Update coordinates when marker is dragged
                function updateCoordinates() {
                    const lngLat = marker.getLngLat();
                    document.getElementById('latitude').value = lngLat.lat.toFixed(6);
                    document.getElementById('longitude').value = lngLat.lng.toFixed(6);
                }

                marker.on('dragend', updateCoordinates);

                // Set marker when clicking on the map
                map.on('click', function(e) {
                    marker.setLngLat(e.lngLat);
                    updateCoordinates();
                });

                // Use current location button
                document.getElementById('current-location').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;

                            marker.setLngLat([lng, lat]);
                            map.flyTo({
                                center: [lng, lat],
                                zoom: 14
                            });

                            document.getElementById('latitude').value = lat.toFixed(6);
                            document.getElementById('longitude').value = lng.toFixed(6);
                        }, function() {
                            alert('Unable to get your location');
                        });
                    } else {
                        alert('Geolocation is not supported by your browser');
                    }
                });
            }
        }
    });
</script>
{% endblock %}